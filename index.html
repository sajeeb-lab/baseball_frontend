<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Elite Baseball – Find Teams</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>

/* ═══════════════════════════════════════════════════════════
   VARIABLES & RESET
═══════════════════════════════════════════════════════════ */
:root {
  --navy:  #0a1628;
  --navy2: #0d1f3c;
  --red:   #c8102e;
  --red2:  #a50d25;
  --gold:  #f5c518;
  --white: #ffffff;
  --light: #f4f6f9;
  --mid:   #dce3ec;
  --text:  #1a1a2e;
  --sub:   #5a6a7a;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Open Sans', sans-serif;
  background: var(--light);
  color: var(--text);
  min-height: 100vh;
}

/* ═══════════════════════════════════════════════════════════
   TOP UTILITY BAR
═══════════════════════════════════════════════════════════ */
.top-bar {
  background: var(--navy);
  padding: 6px 2rem;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1.4rem;
}
.top-bar a {
  color: #8899bb;
  font-size: 0.68rem;
  text-decoration: none;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  transition: color .2s;
}
.top-bar a:hover { color: var(--gold); }

/* ═══════════════════════════════════════════════════════════
   NAVBAR
═══════════════════════════════════════════════════════════ */
nav {
  background: var(--red);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 2rem;
  box-shadow: 0 3px 14px rgba(0,0,0,.28);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* Logo */
.nav-logo {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: 10px 0;
  text-decoration: none;
}
.logo-icon {
  width: 46px; height: 46px;
  background: var(--white);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Oswald', sans-serif;
  font-weight: 700;
  font-size: .72rem;
  color: var(--red);
  line-height: 1.1;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
  flex-shrink: 0;
}
.logo-text .main {
  display: block;
  font-family: 'Oswald', sans-serif;
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--white);
  letter-spacing: .05em;
  text-transform: uppercase;
  line-height: 1;
}
.logo-text .sub {
  display: block;
  font-size: .6rem;
  color: rgba(255,255,255,.7);
  letter-spacing: .18em;
  text-transform: uppercase;
}

/* Nav links */
.nav-links { display: flex; list-style: none; }
.nav-links li a {
  display: block;
  padding: 18px 15px;
  color: var(--white);
  text-decoration: none;
  font-family: 'Oswald', sans-serif;
  font-size: .8rem;
  font-weight: 500;
  letter-spacing: .08em;
  text-transform: uppercase;
  border-bottom: 3px solid transparent;
  transition: background .18s, border-color .18s, color .18s;
}
.nav-links li a:hover,
.nav-links li a.active {
  background: rgba(0,0,0,.15);
  border-bottom-color: var(--gold);
  color: var(--gold);
}

/* ═══════════════════════════════════════════════════════════
   HERO BANNER + SEARCH
═══════════════════════════════════════════════════════════ */
.hero {
  background: linear-gradient(135deg, var(--navy) 0%, #162845 100%);
  padding: 3rem 2rem 2.8rem;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute; inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E");
}
.hero h1 {
  font-family: 'Oswald', sans-serif;
  font-size: clamp(1.8rem, 4vw, 3rem);
  font-weight: 700;
  color: var(--white);
  letter-spacing: .05em;
  text-transform: uppercase;
  margin-bottom: .5rem;
  position: relative;
}
.hero h1 span { color: var(--gold); }
.hero p {
  color: rgba(255,255,255,.65);
  font-size: .92rem;
  margin-bottom: 1.8rem;
  position: relative;
}

/* Search bar */
.search-wrap {
  position: relative;
  max-width: 520px;
  margin: 0 auto;
  display: flex;
}
.search-wrap input {
  flex: 1;
  padding: 14px 18px;
  border: 2px solid rgba(255,255,255,.15);
  border-right: none;
  border-radius: 4px 0 0 4px;
  background: rgba(255,255,255,.08);
  color: var(--white);
  font-family: 'Open Sans', sans-serif;
  font-size: .9rem;
  outline: none;
  transition: border-color .2s, background .2s;
}
.search-wrap input::placeholder { color: rgba(255,255,255,.4); }
.search-wrap input:focus {
  border-color: var(--gold);
  background: rgba(255,255,255,.12);
}
.search-btn {
  padding: 14px 22px;
  background: var(--gold);
  border: none;
  border-radius: 0 4px 4px 0;
  cursor: pointer;
  font-family: 'Oswald', sans-serif;
  font-size: .82rem;
  font-weight: 600;
  color: var(--navy);
  letter-spacing: .1em;
  text-transform: uppercase;
  transition: background .2s;
  white-space: nowrap;
}
.search-btn:hover { background: #ffd330; }

/* Search suggestions dropdown */
#suggestions {
  position: absolute;
  top: 100%; left: 0; right: 52px;
  background: var(--white);
  border: 1px solid var(--mid);
  border-top: none;
  z-index: 200;
  display: none;
  border-radius: 0 0 4px 4px;
  box-shadow: 0 6px 20px rgba(0,0,0,.15);
  max-height: 260px;
  overflow-y: auto;
}
#suggestions.open { display: block; }
.sug-item {
  padding: 10px 16px;
  cursor: pointer;
  font-size: .84rem;
  color: var(--text);
  border-bottom: 1px solid var(--mid);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background .15s;
}
.sug-item:last-child { border-bottom: none; }
.sug-item:hover { background: var(--light); }
.sug-badge {
  background: var(--navy);
  color: var(--white);
  font-family: 'Oswald', sans-serif;
  font-size: .7rem;
  font-weight: 600;
  padding: 2px 7px;
  border-radius: 3px;
  letter-spacing: .05em;
  min-width: 34px;
  text-align: center;
  flex-shrink: 0;
}

/* ═══════════════════════════════════════════════════════════
   MAIN CONTENT AREA
═══════════════════════════════════════════════════════════ */
.main {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2.5rem 1.5rem;
}

/* Section header */
.section-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.6rem;
}
.section-header h2 {
  font-family: 'Oswald', sans-serif;
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--navy);
  text-transform: uppercase;
  letter-spacing: .05em;
  white-space: nowrap;
}
.section-header .bar {
  flex: 1;
  height: 2px;
  background: linear-gradient(to right, var(--red), transparent);
}
.section-header .hint {
  font-size: .78rem;
  color: var(--sub);
  letter-spacing: .04em;
  white-space: nowrap;
}

/* ═══════════════════════════════════════════════════════════
   MAP CARD
═══════════════════════════════════════════════════════════ */
.map-card {
  background: var(--white);
  border-radius: 6px;
  box-shadow: 0 2px 16px rgba(0,0,0,.08);
  padding: 1.8rem 1.5rem 1.2rem;
  margin-bottom: 2rem;
  border-top: 4px solid var(--red);
}
.map-hint {
  text-align: center;
  color: var(--sub);
  font-size: .78rem;
  letter-spacing: .05em;
  margin-bottom: 1rem;
  text-transform: uppercase;
}
#map-svg-container { width: 100%; }
#map-svg-container svg { width: 100%; height: auto; display: block; }

/* State path styles */
.state-path {
  fill: #111111;
  stroke: #ffffff;
  stroke-width: .8px;
  stroke-linejoin: round;
  cursor: pointer;
  transition: fill .15s ease;
}
.state-path:hover  { fill: var(--red); }
.state-path.active { fill: var(--navy); }

/* Map loading message */
#map-loading {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--sub);
  font-size: .9rem;
  letter-spacing: .05em;
}

/* ═══════════════════════════════════════════════════════════
   MAP TOOLTIP
═══════════════════════════════════════════════════════════ */
#map-tooltip {
  position: fixed;
  background: var(--navy);
  color: var(--white);
  font-family: 'Oswald', sans-serif;
  font-size: .9rem;
  font-weight: 500;
  letter-spacing: .08em;
  padding: 6px 14px;
  pointer-events: none;
  opacity: 0;
  transition: opacity .1s;
  z-index: 9999;
  white-space: nowrap;
  border-radius: 3px;
  transform: translate(-50%, -145%);
  text-transform: uppercase;
}
#map-tooltip::after {
  content: '';
  position: absolute;
  bottom: -6px; left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-bottom: none;
  border-top-color: var(--navy);
}
#map-tooltip.show { opacity: 1; }

/* ═══════════════════════════════════════════════════════════
   RESULT PANEL (teams list)
═══════════════════════════════════════════════════════════ */
#result-panel {
  display: none;
  animation: fadeUp .25s ease;
}
#result-panel.visible { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Result header bar */
.result-header {
  background: var(--navy);
  color: var(--white);
  padding: 16px 22px;
  border-radius: 6px 6px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}
.result-header h3 {
  font-family: 'Oswald', sans-serif;
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: .06em;
  text-transform: uppercase;
}
.result-meta {
  font-size: .75rem;
  color: rgba(255,255,255,.5);
  margin-top: 2px;
}
.close-btn {
  background: rgba(255,255,255,.15);
  border: none;
  color: var(--white);
  width: 30px; height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background .2s;
  flex-shrink: 0;
}
.close-btn:hover { background: var(--red2); }

/* Teams grid */
.teams-grid {
  background: var(--white);
  border: 1px solid var(--mid);
  border-top: none;
  border-radius: 0 0 6px 6px;
  padding: 1.5rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 1rem;
  min-height: 100px;
}

/* Loading skeleton animation */
.skeleton {
  background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
  background-size: 200% 100%;
  animation: shimmer 1.2s infinite;
  border-radius: 4px;
  height: 140px;
}
@keyframes shimmer {
  from { background-position: 200% 0; }
  to   { background-position: -200% 0; }
}

/* ═══════════════════════════════════════════════════════════
   TEAM CARD
═══════════════════════════════════════════════════════════ */
.team-card {
  background: var(--light);
  border: 1px solid var(--mid);
  border-radius: 5px;
  padding: 15px 16px;
  border-left: 4px solid var(--red);
  transition: box-shadow .2s, transform .2s;
}
.team-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,.1);
  transform: translateY(-2px);
}

/* Card elements */
.tc-age {
  font-size: .67rem;
  color: var(--sub);
  letter-spacing: .1em;
  text-transform: uppercase;
  margin-bottom: 5px;
}
.tc-name {
  font-family: 'Oswald', sans-serif;
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--navy);
  letter-spacing: .02em;
  line-height: 1.2;
  margin-bottom: 6px;
}
.tc-location {
  font-size: .78rem;
  color: var(--sub);
  margin-bottom: 2px;
}
.tc-coach {
  font-size: .76rem;
  color: var(--sub);
  margin-top: 3px;
}
.tc-asst {
  font-size: .73rem;
  color: var(--sub);
  margin-top: 2px;
}
.tc-details {
  font-size: .74rem;
  color: var(--sub);
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--mid);
  line-height: 1.5;
}
.tc-details-toggle {
  background: none;
  border: none;
  color: var(--red);
  font-size: .72rem;
  cursor: pointer;
  padding: 0;
  margin-top: 6px;
  font-family: 'Open Sans', sans-serif;
  text-decoration: underline;
}

/* No teams / error messages */
.no-teams {
  grid-column: 1 / -1;
  text-align: center;
  padding: 3rem 1rem;
  color: var(--sub);
  font-size: .92rem;
  line-height: 1.8;
}
.no-teams strong { color: var(--navy); display: block; margin-bottom: .5rem; font-size: 1rem; }
.error-box {
  grid-column: 1 / -1;
  background: #fff5f5;
  border: 1px solid #ffc0c0;
  border-radius: 4px;
  padding: 1.5rem;
  text-align: center;
  color: var(--red);
  font-size: .88rem;
  line-height: 1.6;
}
.error-box strong { display: block; margin-bottom: .4rem; font-size: 1rem; }

/* ═══════════════════════════════════════════════════════════
   FOOTER
═══════════════════════════════════════════════════════════ */
footer {
  background: var(--navy);
  color: rgba(255,255,255,.5);
  text-align: center;
  padding: 2.5rem 2rem;
  font-size: .72rem;
  letter-spacing: .08em;
  margin-top: 3rem;
}
.footer-links {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: .4rem 1.4rem;
  margin-bottom: 1.2rem;
}
.footer-links a {
  color: rgba(255,255,255,.45);
  font-size: .68rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  text-decoration: none;
  transition: color .2s;
}
.footer-links a:hover { color: var(--gold); }
footer a { color: var(--gold); text-decoration: none; }
footer p { line-height: 1.8; }

/* ═══════════════════════════════════════════════════════════
   RESPONSIVE
═══════════════════════════════════════════════════════════ */
@media (max-width: 640px) {
  .nav-links li a { padding: 18px 10px; font-size: .72rem; }
  .top-bar { display: none; }
  .main { padding: 1.5rem 1rem; }
  .teams-grid { grid-template-columns: 1fr; }
}

</style>
</head>
<body>

<!-- ── TOP UTILITY BAR ─────────────────────────────────────────────────── -->
<div class="top-bar">
  <a href="#">Prospect Form</a>
  <a href="#">Coach Application</a>
  <a href="#">Mission Statement</a>
  <a href="#">Contact US Elite</a>
</div>

<!-- ── NAVBAR ──────────────────────────────────────────────────────────── -->
<nav>
  <a href="#" class="nav-logo">
    <div class="logo-icon">US<br>ELITE</div>
    <div class="logo-text">
      <span class="main">US Elite Baseball</span>
      <span class="sub">Uncommon Standards</span>
    </div>
  </a>
  <ul class="nav-links">
    <li><a href="#" class="active">US Elite Teams</a></li>
    <li><a href="#">Commitments</a></li>
    <li><a href="#">Tryouts</a></li>
    <li><a href="#">Privacy Policy</a></li>
  </ul>
</nav>

<!-- ── HERO + SEARCH ───────────────────────────────────────────────────── -->
<div class="hero">
  <h1>Find <span>US Elite</span> Teams</h1>
  <p>Click any state on the map — or search by state name below</p>
  <div class="search-wrap">
    <input
      type="text"
      id="search-input"
      placeholder="Search state name or abbreviation…"
      autocomplete="off"
      aria-label="Search states"
    >
    <div id="suggestions" role="listbox"></div>
    <button class="search-btn" onclick="doSearch()">Search</button>
  </div>
</div>

<!-- ── MAIN ────────────────────────────────────────────────────────────── -->
<div class="main">

  <div class="section-header">
    <h2>Select a State</h2>
    <div class="bar"></div>
    <span class="hint">Click any state to view teams</span>
  </div>

  <!-- Map -->
  <div class="map-card">
    <p class="map-hint">⚾ Click a state on the map to load live team data from GHL</p>
    <div id="map-svg-container">
      <div id="map-loading">Loading map…</div>
    </div>
  </div>

  <!-- Teams result panel (hidden until a state is clicked) -->
  <div id="result-panel">
    <div class="result-header">
      <div>
        <h3 id="result-title">Teams</h3>
        <div class="result-meta" id="result-meta"></div>
      </div>
      <button class="close-btn" onclick="closePanel()" title="Close">✕</button>
    </div>
    <div class="teams-grid" id="teams-grid"></div>
  </div>

</div><!-- /.main -->

<!-- ── FOOTER ──────────────────────────────────────────────────────────── -->
<footer>
  <div class="footer-links">
    <a href="#">US Elite Teams</a>
    <a href="#">Commitments</a>
    <a href="#">Privacy Policy</a>
    <a href="#">Prospect Form</a>
    <a href="#">Tryouts</a>
    <a href="#">Coach Application</a>
    <a href="#">Mission Statement</a>
    <a href="#">Contact US Elite</a>
  </div>
  <p>
    We are always looking for new talent. Do you feel you have what it takes?<br>
    <a href="#">Click here to register for an upcoming tryout!</a>
  </p>
  <p style="margin-top:.8rem; color:rgba(255,255,255,.35)">
    Copyright &copy; 2026 US Elite Baseball &nbsp;&middot;&nbsp;
    <a href="/cdn-cgi/l/email-protection#f3808683839c8187b38680969f9a87969192809691929f9fdd909c9e"><span class="__cf_email__" data-cfemail="bbc8cecbcbd4c9cffbcec8ded7d2cfded9dac8ded9dad7d795d8d4d6">[email&#160;protected]</span></a>
  </p>
</footer>

<!-- Map tooltip (follows cursor) -->
<div id="map-tooltip" role="tooltip"></div>

<!-- ── SCRIPTS ─────────────────────────────────────────────────────────── -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════════════════════
// STATE LOOKUP TABLES
// ═══════════════════════════════════════════════════════════════════════════
const STATE_NAMES = {
  "01":"Alabama",       "02":"Alaska",        "04":"Arizona",
  "05":"Arkansas",      "06":"California",    "08":"Colorado",
  "09":"Connecticut",   "10":"Delaware",      "12":"Florida",
  "13":"Georgia",       "15":"Hawaii",        "16":"Idaho",
  "17":"Illinois",      "18":"Indiana",       "19":"Iowa",
  "20":"Kansas",        "21":"Kentucky",      "22":"Louisiana",
  "23":"Maine",         "24":"Maryland",      "25":"Massachusetts",
  "26":"Michigan",      "27":"Minnesota",     "28":"Mississippi",
  "29":"Missouri",      "30":"Montana",       "31":"Nebraska",
  "32":"Nevada",        "33":"New Hampshire", "34":"New Jersey",
  "35":"New Mexico",    "36":"New York",      "37":"North Carolina",
  "38":"North Dakota",  "39":"Ohio",          "40":"Oklahoma",
  "41":"Oregon",        "42":"Pennsylvania",  "44":"Rhode Island",
  "45":"South Carolina","46":"South Dakota",  "47":"Tennessee",
  "48":"Texas",         "49":"Utah",          "50":"Vermont",
  "51":"Virginia",      "53":"Washington",    "54":"West Virginia",
  "55":"Wisconsin",     "56":"Wyoming"
};

const STATE_ABBR = {
  "01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT",
  "10":"DE","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN",
  "19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA",
  "26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV",
  "33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH",
  "40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN",
  "48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI",
  "56":"WY"
};

// Flat array used for search suggestions
const ALL_STATES = Object.entries(STATE_NAMES).map(([id, name]) => ({
  id, name, abbr: STATE_ABBR[id]
}));

// ═══════════════════════════════════════════════════════════════════════════
// UTILITY
// ═══════════════════════════════════════════════════════════════════════════

/** Escape HTML special characters to prevent XSS */
function esc(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ═══════════════════════════════════════════════════════════════════════════
// API — FETCH TEAMS FROM BACKEND
// ═══════════════════════════════════════════════════════════════════════════

/**
 * Calls GET /api/teams?state=TX on our Node.js backend.
 * The backend securely calls GHL with the API key and returns team records.
 *
 * Returns: { success, state, total, teams: [...] }
 */
async function fetchTeams(stateAbbr) {
  const BACKEND = 'https://baseball-backend-five.vercel.app';
  const url = `${BACKEND}/api/teams?state=${encodeURIComponent(stateAbbr)}`;
  const res = await fetch(url);

  // Try to parse JSON even on error responses
  let data;
  try { data = await res.json(); }
  catch(e) { throw new Error(`Server returned an invalid response (${res.status})`); }

  if (!res.ok) {
    throw new Error(data?.error || `Request failed with status ${res.status}`);
  }

  return data;
}

// ═══════════════════════════════════════════════════════════════════════════
// LOADING SKELETONS
// ═══════════════════════════════════════════════════════════════════════════
function showSkeletons(grid, count = 4) {
  grid.innerHTML = Array(count)
    .fill('<div class="skeleton"></div>')
    .join('');
}

// ═══════════════════════════════════════════════════════════════════════════
// RENDER TEAM CARDS
// ═══════════════════════════════════════════════════════════════════════════
function renderTeams(grid, teams, stateName) {
  grid.innerHTML = '';

  if (!teams || teams.length === 0) {
    grid.innerHTML = `
      <div class="no-teams">
        <strong>No teams found in ${esc(stateName)}</strong>
        There are currently no teams listed for this state in your GHL database.<br>
        Make sure records have the <strong>State</strong> field filled in with <strong>${esc(stateName.slice(0,2).toUpperCase())}</strong>.
      </div>`;
    return;
  }

  teams.forEach(team => {
    const card = document.createElement('div');
    card.className = 'team-card';

    // Age + state badge
    const ageLine = team.ageGroup
      ? `<div class="tc-age">${esc(team.ageGroup)} &bull; ${esc(team.state)}</div>`
      : `<div class="tc-age">${esc(team.state)}</div>`;

    // Location
    const locationLine = team.location
      ? `<div class="tc-location">&#128205; ${esc(team.location)}, ${esc(team.state)}</div>`
      : `<div class="tc-location">&#128205; ${esc(team.state)}</div>`;

    // Coaches
    const headCoach = team.headCoach
      ? `<div class="tc-coach">&#128100; <strong>HC:</strong> ${esc(team.headCoach)}</div>`
      : '';
    const asst1 = team.assistantCoach1
      ? `<div class="tc-asst">&#128100; <strong>AC1:</strong> ${esc(team.assistantCoach1)}</div>`
      : '';
    const asst2 = team.assistantCoach2
      ? `<div class="tc-asst">&#128100; <strong>AC2:</strong> ${esc(team.assistantCoach2)}</div>`
      : '';

    // Details (truncated with toggle if long)
    let detailsHtml = '';
    if (team.details) {
      const id = `details-${esc(team.id)}`;
      const short = team.details.length > 100
        ? team.details.slice(0, 100) + '…'
        : team.details;
      const showToggle = team.details.length > 100;
      detailsHtml = `
        <div class="tc-details">
          <span id="${id}">${esc(short)}</span>
          ${showToggle ? `<button class="tc-details-toggle" onclick="toggleDetails(this,'${id}','${esc(team.details).replace(/'/g,"\\'")}')">Read more</button>` : ''}
        </div>`;
    }

    card.innerHTML = `
      ${ageLine}
      <div class="tc-name">${esc(team.teamName)}</div>
      ${locationLine}
      ${headCoach}
      ${asst1}
      ${asst2}
      ${detailsHtml}
    `;

    grid.appendChild(card);
  });
}

/** Expand/collapse the details text on a card */
function toggleDetails(btn, spanId, fullText) {
  const span = document.getElementById(spanId);
  if (!span) return;
  const isExpanded = btn.textContent === 'Read less';
  if (isExpanded) {
    span.textContent = fullText.slice(0, 100) + '…';
    btn.textContent = 'Read more';
  } else {
    span.textContent = fullText;
    btn.textContent = 'Read less';
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// OPEN STATE PANEL
// Called when a state is clicked on the map or selected via search
// ═══════════════════════════════════════════════════════════════════════════
async function openState(abbr, name) {
  const panel = document.getElementById('result-panel');
  const grid  = document.getElementById('teams-grid');
  const title = document.getElementById('result-title');
  const meta  = document.getElementById('result-meta');

  // Show panel immediately with loading state
  title.textContent = `Teams in ${name} (${abbr})`;
  meta.textContent  = 'Loading from GHL…';
  showSkeletons(grid, 4);
  panel.classList.add('visible');

  // Scroll to results smoothly
  setTimeout(() => {
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 50);

  // Fetch real data from backend
  try {
    const data = await fetchTeams(abbr);
    meta.textContent = data.total > 0
      ? `${data.total} team${data.total !== 1 ? 's' : ''} found`
      : 'No teams found';
    renderTeams(grid, data.teams, name);
  } catch (err) {
    meta.textContent = '';
    grid.innerHTML = `
      <div class="error-box">
        <strong>⚠️ Failed to load teams</strong>
        ${esc(err.message)}<br>
        <small style="opacity:.7;margin-top:.5rem;display:block">
          Check that GHL_API_KEY and GHL_LOCATION_ID are set in your Vercel environment variables.<br>
          Visit <a href='https://baseball-backend-five.vercel.app/api/health' target='_blank'><strong>/api/health</strong></a> to diagnose the issue.
        </small>
      </div>`;
    console.error('[fetchTeams error]', err);
  }
}

/** Close the result panel and deselect the map state */
function closePanel() {
  document.getElementById('result-panel').classList.remove('visible');
  if (svgRef) svgRef.selectAll('.state-path').classed('active', false);
}

// ═══════════════════════════════════════════════════════════════════════════
// D3 MAP INITIALIZATION
// ═══════════════════════════════════════════════════════════════════════════
const mapTooltip = document.getElementById('map-tooltip');
let svgRef = null;

async function initMap() {
  try {
    // Load the US TopoJSON from CDN
    const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');

    // Remove loading message
    const loadingEl = document.getElementById('map-loading');
    if (loadingEl) loadingEl.remove();

    const W = 960, H = 580;

    // Create SVG
    const svg = d3.select('#map-svg-container')
      .append('svg')
      .attr('viewBox', `0 0 ${W} ${H}`)
      .attr('aria-label', 'Interactive USA map — click a state to find teams');
    svgRef = svg;

    // Set up projection and path generator
    const projection = d3.geoAlbersUsa()
      .scale(1280)
      .translate([W / 2, H / 2]);
    const pathGen = d3.geoPath().projection(projection);

    // Extract state features from TopoJSON
    const states = topojson.feature(us, us.objects.states);

    // Draw all states
    svg.selectAll('.state-path')
      .data(states.features)
      .join('path')
      .attr('class', 'state-path')
      .attr('d', pathGen)
      .attr('aria-label', d => {
        const id = d.id.toString().padStart(2, '0');
        return STATE_NAMES[id] || '';
      })
      // Tooltip on hover
      .on('mouseenter', function(event, d) {
        const id   = d.id.toString().padStart(2, '0');
        const abbr = STATE_ABBR[id] || '';
        const name = STATE_NAMES[id] || '';
        if (!abbr) return;
        mapTooltip.textContent = `${abbr} — ${name}`;
        mapTooltip.classList.add('show');
      })
      .on('mousemove', function(event) {
        mapTooltip.style.left = event.clientX + 'px';
        mapTooltip.style.top  = event.clientY + 'px';
      })
      .on('mouseleave', function() {
        mapTooltip.classList.remove('show');
      })
      // Click to load teams
      .on('click', function(event, d) {
        const id   = d.id.toString().padStart(2, '0');
        const abbr = STATE_ABBR[id];
        const name = STATE_NAMES[id];
        if (!abbr) return;

        // Highlight clicked state
        svg.selectAll('.state-path').classed('active', false);
        d3.select(this).classed('active', true);

        // Load teams for this state
        openState(abbr, name);
      });

  } catch (err) {
    const loadingEl = document.getElementById('map-loading');
    if (loadingEl) {
      loadingEl.textContent = '⚠️ Failed to load map. Please check your internet connection.';
      loadingEl.style.color = 'var(--red)';
    }
    console.error('[initMap error]', err);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════════════════════════════════
const searchInput   = document.getElementById('search-input');
const suggestionsEl = document.getElementById('suggestions');

// Show suggestions as user types
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  suggestionsEl.innerHTML = '';

  if (!q) {
    suggestionsEl.classList.remove('open');
    return;
  }

  const matches = ALL_STATES.filter(s =>
    s.name.toLowerCase().includes(q) ||
    s.abbr.toLowerCase() === q ||
    s.abbr.toLowerCase().startsWith(q)
  ).slice(0, 8);

  if (!matches.length) {
    suggestionsEl.classList.remove('open');
    return;
  }

  matches.forEach(s => {
    const div = document.createElement('div');
    div.className = 'sug-item';
    div.setAttribute('role', 'option');
    div.innerHTML = `<span class="sug-badge">${esc(s.abbr)}</span>${esc(s.name)}`;
    div.addEventListener('click', () => {
      searchInput.value = s.name;
      suggestionsEl.classList.remove('open');
      // Highlight on map too
      if (svgRef) {
        svgRef.selectAll('.state-path')
          .classed('active', d => {
            const id = d.id.toString().padStart(2, '0');
            return STATE_ABBR[id] === s.abbr;
          });
      }
      openState(s.abbr, s.name);
    });
    suggestionsEl.appendChild(div);
  });

  suggestionsEl.classList.add('open');
});

// Close suggestions when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.search-wrap')) {
    suggestionsEl.classList.remove('open');
  }
});

// Handle Enter key in search
searchInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') doSearch();
  if (e.key === 'Escape') suggestionsEl.classList.remove('open');
});

/** Find the matching state and open it */
function doSearch() {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) return;

  const match = ALL_STATES.find(s =>
    s.name.toLowerCase() === q ||
    s.abbr.toLowerCase() === q
  );

  if (match) {
    suggestionsEl.classList.remove('open');
    if (svgRef) {
      svgRef.selectAll('.state-path')
        .classed('active', d => {
          const id = d.id.toString().padStart(2, '0');
          return STATE_ABBR[id] === match.abbr;
        });
    }
    openState(match.abbr, match.name);
  } else {
    // Partial match — open first suggestion
    const partial = ALL_STATES.find(s =>
      s.name.toLowerCase().startsWith(q) ||
      s.abbr.toLowerCase().startsWith(q)
    );
    if (partial) {
      searchInput.value = partial.name;
      suggestionsEl.classList.remove('open');
      openState(partial.abbr, partial.name);
    }
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// BOOT
// ═�
